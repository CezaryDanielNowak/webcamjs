// WebcamJS v1.0.6 - http://github.com/jhuckaby/webcamjs - MIT Licensed
(function(e){var a;var t=location.protocol.match(/https/i)?"https":"http";var s="webcam_movie_embed";var i="webcam_movie_obj";var r=e.URL||e.webkitURL||e.mozURL||e.msURL;var h=e.localStorage;var o=navigator;var Webcam={version:"1.0.6",loaded:false,live:false,userMedia:true,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,force_flash:false,flip_horiz:false,fps:30,upload_name:"webcam",constraints:null,swfURL:"",flashNotDetectedText:"ERROR: No Adobe Flash Player detected.  Webcam.js relies on Flash for browsers that do not support getUserMedia (like yours).",enable_upload_fallback:true,css_prefix:"webcamjs"},hooks:{},init:function(){var a=this;this.mediaDevices=o.mediaDevices&&o.mediaDevices.getUserMedia?o.mediaDevices:o.mozGetUserMedia||o.webkitGetUserMedia?{getUserMedia:function(e){return new Promise(function(a,t){(o.mozGetUserMedia||o.webkitGetUserMedia).call(o,e,a,t)})}}:null;this.userMedia=this.userMedia&&!!this.mediaDevices&&!!r;if(o.userAgent.match(/Firefox\D+(\d+)/)){if(parseInt(RegExp.$1,10)<21)this.userMedia=null}if(this.userMedia){e.addEventListener("beforeunload",function(e){a.reset()})}},attach:function(t){if(typeof t=="string"){t=document.getElementById(t)||document.querySelector(t)}if(!t){return this.dispatch("error","Could not locate DOM element to attach to.")}this.container=t;t.innerHTML="";var s=document.createElement("div");s.className=this.params.css_prefix+"__peg";t.appendChild(s);this.peg=s;if(!this.params.width)this.params.width=t.offsetWidth;if(!this.params.height)this.params.height=t.offsetHeight;if(!this.params.dest_width)this.params.dest_width=this.params.width;if(!this.params.dest_height)this.params.dest_height=this.params.height;this.userMedia=a===undefined?this.userMedia:a;if(this.params.force_flash){a=this.userMedia;this.userMedia=null}if(typeof this.params.fps!=="number")this.params.fps=30;var i=this.params.width/this.params.dest_width;var h=this.params.height/this.params.dest_height;if(this.userMedia){var o=document.createElement("video");o.className=this.params.css_prefix+"__video";o.setAttribute("autoplay","autoplay");o.style.width=""+this.params.dest_width+"px";o.style.height=""+this.params.dest_height+"px";if(i!=1||h!=1){t.style.overflow="hidden";o.style.webkitTransformOrigin="0px 0px";o.style.mozTransformOrigin="0px 0px";o.style.msTransformOrigin="0px 0px";o.style.oTransformOrigin="0px 0px";o.style.transformOrigin="0px 0px";o.style.webkitTransform="scaleX("+i+") scaleY("+h+")";o.style.mozTransform="scaleX("+i+") scaleY("+h+")";o.style.msTransform="scaleX("+i+") scaleY("+h+")";o.style.oTransform="scaleX("+i+") scaleY("+h+")";o.style.transform="scaleX("+i+") scaleY("+h+")"}t.appendChild(o);this.video=o;var l=this;this.mediaDevices.getUserMedia({audio:false,video:this.params.constraints||{mandatory:{minWidth:this.params.dest_width,minHeight:this.params.dest_height}}}).then(function(e){o.src=r.createObjectURL(e)||e;l.stream=e;l.loaded=true;l.live=true;l.dispatch("load");l.dispatch("live");l.flip()}).catch(function(e){return l.dispatch("error","Could not access webcam: "+e.name+": "+e.message,e)})}else if(!this.hasFlash()&&this.params.enable_upload_fallback){t.appendChild(this.getUploadFallbackNode())}else{e.Webcam=Webcam;var n=document.createElement("div");n.className=this.params.css_prefix+"__flash-container";n.innerHTML=this.getSWFHTML();t.appendChild(n)}if(this.params.crop_width&&this.params.crop_height){var c=Math.floor(this.params.crop_width*i);var p=Math.floor(this.params.crop_height*h);t.style.width=""+c+"px";t.style.height=""+p+"px";t.style.overflow="hidden";t.scrollLeft=Math.floor(this.params.width/2-c/2);t.scrollTop=Math.floor(this.params.height/2-p/2)}else{t.style.width=""+this.params.width+"px";t.style.height=""+this.params.height+"px"}},reset:function(){if(this.preview_active)this.unfreeze();this.unflip();if(this.userMedia){if(this.stream){if(this.stream.getVideoTracks){var e=this.stream.getVideoTracks();if(e&&e[0]&&e[0].stop)e[0].stop()}else if(this.stream.stop){this.stream.stop()}}delete this.stream;delete this.video}if(this.userMedia!==true){this.getMovie()._releaseCamera()}if(this.container){this.container.innerHTML="";delete this.container}this.loaded=false;this.live=false;delete this.fallbackImage},set:function(){if(arguments.length==1){for(var e in arguments[0]){this.params[e]=arguments[0][e]}}else{this.params[arguments[0]]=arguments[1]}},on:function(e,a){e=e.replace(/^on/i,"").toLowerCase();if(!this.hooks[e])this.hooks[e]=[];this.hooks[e].push(a)},off:function(e,a){e=e.replace(/^on/i,"").toLowerCase();if(this.hooks[e]){if(a){var t=this.hooks[e].indexOf(a);if(t>-1)this.hooks[e].splice(t,1)}else{this.hooks[e]=[]}}},dispatch:function(){var a=arguments[0].replace(/^on/i,"").toLowerCase();var t=Array.prototype.slice.call(arguments,1);if(this.hooks[a]&&this.hooks[a].length){for(var s=0,i=this.hooks[a].length;s<i;s++){var r=this.hooks[a][s];if(typeof r=="function"){r.apply(this,t)}else if(typeof r=="object"&&r.length==2){r[0][r[1]].apply(r[0],t)}else if(e[r]){e[r].apply(e,t)}}return true}else if(a=="error"){alert("Webcam.js Error: "+t[0])}return false},setSWFLocation:function(e){this.set("swfURL",e)},hasFlash:function(){var a="Shockwave Flash",t="ShockwaveFlash.ShockwaveFlash",s="application/x-shockwave-flash",i=false;if(typeof o.plugins!=="undefined"&&typeof o.plugins[a]==="object"){var r=o.plugins[a].description;if(r&&(typeof o.mimeTypes!=="undefined"&&o.mimeTypes[s]&&o.mimeTypes[s].enabledPlugin)){i=true}}else if(typeof e.ActiveXObject!=="undefined"){try{var h=new ActiveXObject(t);if(h){var l=h.GetVariable("$version");if(l)i=true}}catch(n){}}return i},getUploadFallbackNode:function(){var e=document.createElement("input");e.type="file";e.accept="image/*";e.setAttribute("capture","camera");e.id="imageLoader";e.name="imageLoader";var a=document.createElement("div");a.className=this.params.css_prefix+"__upload-fallback";a.appendChild(e);e.addEventListener("change",n.bind(this),false);return a},getSWFHTML:function(){var e="",a=this.params.swfURL;if(location.protocol.match(/file/)){this.dispatch("error","Flash does not work from local disk.  Please run from a web server.");return'<h3 class="'+this.params.css_prefix+'__error">ERROR: the Webcam.js Flash fallback does not work from local disk.  Please run it from a web server.</h3>'}if(!this.hasFlash()){this.dispatch("error","Adobe Flash Player not found.  Please install from get.adobe.com/flashplayer and try again.");return'<h3 style="'+this.params.css_prefix+'__error">'+this.params.flashNotDetectedText+"</h3>"}if(!a){var r="";var o=document.getElementsByTagName("script");for(var l=0,n=o.length;l<n;l++){var c=o[l].getAttribute("src");if(c&&c.match(/\/webcam(\.min)?\.js/)){r=c.replace(/\/webcam(\.min)?\.js.*$/,"");l=n}}a="webcam.swf";if(r){a=r+"/"+a}}if(h&&!h.getItem("webcamjs_visited")){this.params.new_user=1;h.setItem("webcamjs_visited",1)}var p="";for(var d in this.params){if(p)p+="&";p+=d+"="+escape(this.params[d])}e+='<object class="'+this.params.css_prefix+'__flash" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+t+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="'+i+'" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+a+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+p+'"/><embed id="'+s+'" src="'+a+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="'+s+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+p+'"></embed></object>';return e},getMovie:function(){if(!this.loaded)return this.dispatch("error","Flash Movie is not loaded yet");var e=document.getElementById(i);if(!e||!e._snap)e=document.getElementById(s);if(!e)this.dispatch("error","Cannot locate Flash movie in DOM");return e},freeze:function(){var e=this;var a=this.params;if(this.preview_active)this.unfreeze();var t=this.params.width/this.params.dest_width;var s=this.params.height/this.params.dest_height;this.unflip();var i=a.crop_width||a.dest_width;var r=a.crop_height||a.dest_height;var h=document.createElement("canvas");preview_canvaspeg.className=this.params.css_prefix+"__preview";h.width=i;h.height=r;var o=h.getContext("2d");this.preview_canvas=h;this.preview_context=o;if(t!=1||s!=1){h.style.webkitTransformOrigin="0px 0px";h.style.mozTransformOrigin="0px 0px";h.style.msTransformOrigin="0px 0px";h.style.oTransformOrigin="0px 0px";h.style.transformOrigin="0px 0px";h.style.webkitTransform="scaleX("+t+") scaleY("+s+")";h.style.mozTransform="scaleX("+t+") scaleY("+s+")";h.style.msTransform="scaleX("+t+") scaleY("+s+")";h.style.oTransform="scaleX("+t+") scaleY("+s+")";h.style.transform="scaleX("+t+") scaleY("+s+")"}this.snap(function(){h.style.position="relative";h.style.left=""+e.container.scrollLeft+"px";h.style.top=""+e.container.scrollTop+"px";e.container.insertBefore(h,e.peg);e.container.style.overflow="hidden";e.preview_active=true},h)},unfreeze:function(){if(this.preview_active){this.container.removeChild(this.preview_canvas);delete this.preview_context;delete this.preview_canvas;this.preview_active=false;this.flip()}},flip:function(){if(this.params.flip_horiz){var e=this.container.style;e.webkitTransform="scaleX(-1)";e.mozTransform="scaleX(-1)";e.msTransform="scaleX(-1)";e.oTransform="scaleX(-1)";e.transform="scaleX(-1)";e.filter="FlipH";e.msFilter="FlipH"}},unflip:function(){if(this.params.flip_horiz){var e=this.container.style;e.webkitTransform="scaleX(1)";e.mozTransform="scaleX(1)";e.msTransform="scaleX(1)";e.oTransform="scaleX(1)";e.transform="scaleX(1)";e.filter="";e.msFilter=""}},savePreview:function(e,a){var t=this.params;var s=this.preview_canvas;var i=this.preview_context;if(a){var r=a.getContext("2d");r.drawImage(s,0,0)}e(a?null:s.toDataURL("image/"+t.image_format,t.jpeg_quality/100),s,i);this.unfreeze()},snap:function(e,a){var t=this;var s=this.params;if(!e)return this.dispatch("error","Please provide a callback function or canvas to snap()");if(this.preview_active){this.savePreview(e,a);return null}var i=document.createElement("canvas");i.width=this.params.dest_width;i.height=this.params.dest_height;var r=i.getContext("2d");if(this.params.flip_horiz){r.translate(s.dest_width,0);r.scale(-1,1)}var h=function(){if(this.src&&this.width&&this.height){r.drawImage(this,0,0,s.dest_width,s.dest_height)}if(s.crop_width&&s.crop_height){var t=document.createElement("canvas");t.width=s.crop_width;t.height=s.crop_height;var h=t.getContext("2d");h.drawImage(i,Math.floor(s.dest_width/2-s.crop_width/2),Math.floor(s.dest_height/2-s.crop_height/2),s.crop_width,s.crop_height,0,0,s.crop_width,s.crop_height);r=h;i=t}if(a){var o=a.getContext("2d");o.drawImage(i,0,0)}e(a?null:i.toDataURL("image/"+s.image_format,s.jpeg_quality/100),i,r)};if(this.userMedia){r.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height);h()}else if(this.hasFlash()){var o=this.getMovie()._snap();var n=new Image;n.onload=h;n.src="data:image/"+this.params.image_format+";base64,"+o}else if(!this.hasFlash()&&this.params.enable_upload_fallback){if(this.fallbackImage){l(this.fallbackImage.data,r);h()}else{return this.dispatch("error","Select picture first.")}}else if(this.loaded){return this.dispatch("error","Webcam has encountered an unknown error.")}else{return this.dispatch("error","Webcam is not loaded yet")}return null},configure:function(e){if(!e)e="camera";this.getMovie()._configure(e)},flashNotify:function(e,a){switch(e){case"flashLoadComplete":this.loaded=true;this.dispatch("load");break;case"cameraLive":this.live=true;this.dispatch("live");this.flip();break;case"error":this.dispatch("error",a);break;default:break}},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0},base64DecToArr:function(e,a){var t=e.replace(/[^A-Za-z0-9\+\/]/g,""),s=t.length,i=a?Math.ceil((s*3+1>>2)/a)*a:s*3+1>>2,r=new Uint8Array(i);for(var h,o,l=0,n=0,c=0;c<s;c++){o=c&3;l|=this.b64ToUint6(t.charCodeAt(c))<<18-6*o;if(o===3||s-c===1){for(h=0;h<3&&n<i;h++,n++){r[n]=l>>>(16>>>h&24)&255}l=0}}return r},upload:function(e,a,t){var s=this.params.upload_name||"webcam";var i="";if(e.match(/^data\:image\/(\w+)/))i=RegExp.$1;else throw"Cannot locate image format in Data URI";var r=e.replace(/^data\:image\/\w+\;base64\,/,"");var h=new XMLHttpRequest;h.open("POST",a,true);if(h.upload&&h.upload.addEventListener){h.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=e.loaded/e.total;Webcam.dispatch("uploadProgress",a,e)}},false)}var o=this;h.onload=function(){if(t)t.apply(o,[h.status,h.responseText,h.statusText]);Webcam.dispatch("uploadComplete",h.status,h.responseText,h.statusText)};var l=new Blob([this.base64DecToArr(r)],{type:"image/"+i});var n=new FormData;n.append(s,l,s+"."+i.replace(/e/,""));h.send(n);return h}};Webcam.init();if(typeof define==="function"&&define.amd){define(function(){return Webcam})}else if(typeof module==="object"&&module.exports){module.exports=Webcam}else{e.Webcam=Webcam}function l(e,a){var t=a.canvas;var s=t.width/e.width;var i=t.height/e.height;var r=Math.min(s,i);var h=(t.width-e.width*r)/2;var o=(t.height-e.height*r)/2;a.clearRect(0,0,t.width,t.height);a.drawImage(e,0,0,e.width,e.height,h,o,e.width*r,e.height*r)}function n(e){var a=new FileReader;var t=this;a.onload=function(e){var a=new Image;a.onload=function(){t.fallbackImage={data:a,width:a.width,height:a.height}};a.src=e.target.result};a.readAsDataURL(e.target.files[0])}})(window);